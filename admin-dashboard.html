<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Ligon - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo-container">
                <div class="logo-icon">
                    <i class="fas fa-spa"></i>
                </div>
                <h2>Ligon Admin</h2>
            </div>
        </div>
        
        <div class="sidebar-search">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Search" id="sidebarSearch">
            <span class="search-shortcut">⌘K</span>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">MENU</div>
                <a href="admin-dashboard.html" class="nav-item active">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
                <a href="admin-produtos.html" class="nav-item">
                    <i class="fas fa-box"></i>
                    <span>Produtos</span>
                </a>
                <a href="admin-servicos.html" class="nav-item">
                    <i class="fas fa-spa"></i>
                    <span>Serviços</span>
                </a>
                <a href="admin-galeria.html" class="nav-item">
                    <i class="fas fa-images"></i>
                    <span>Galeria</span>
                </a>
                <a href="admin-vendas.html" class="nav-item">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Vendas</span>
                </a>
                <a href="admin-relatorios.html" class="nav-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">AGENDA</div>
                <a href="admin-agenda.html" class="nav-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Agenda</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">GENERAL</div>
                <a href="#" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-question-circle"></i>
                    <span>Help</span>
                </a>
                <a href="#" class="nav-item" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Header Bar -->
        <header class="top-header">
            <div class="breadcrumb-nav">
                <button class="breadcrumb-arrow"><i class="fas fa-chevron-left"></i></button>
                <span class="breadcrumb-text">Ligon Admin > Dashboard</span>
                <button class="breadcrumb-arrow"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="header-actions">
                <button class="header-icon-btn" id="helpBtn" title="Ajuda" onclick="openHelpModal()">
                    <i class="fas fa-question-circle"></i>
                </button>
                <button class="header-icon-btn" id="supportBtn" title="Abrir Chamado" onclick="openSupportModal()">
                    <i class="fas fa-envelope"></i>
                </button>
                <button class="header-icon-btn" id="notificationsBtn" title="Notificações" onclick="openNotificationsModal()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationCount">3</span>
                </button>
                <button class="header-icon-btn" id="refreshBtn" title="Atualizar Dados" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="header-icon-btn" id="darkModeToggle" title="Alternar Modo Noturno">
                    <i class="fas fa-moon" id="darkModeIcon"></i>
                </button>
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-details">
                    <span class="user-name" id="userName">Administrador</span>
                    <span class="user-email">admin@ligon.com</span>
                </div>
                <button class="btn-share">
                    <i class="fas fa-share-alt"></i> Share
                </button>
            </div>
        </header>

        <!-- Dashboard Content -->
        <div class="dashboard-wrapper">
            <!-- Dashboard Title -->
            <div class="dashboard-title-section">
                <div>
                    <h1>Dashboard</h1>
                    <p class="dashboard-subtitle">Gerencie produtos, serviços e agendamentos do Ligon Resort Spa com facilidade.</p>
                </div>
                <div class="dashboard-actions">
                    <button class="btn-primary-large">
                        <i class="fas fa-plus"></i> Adicionar Projeto
                    </button>
                    <button class="btn-secondary-large">
                        <i class="fas fa-download"></i> Importar Dados
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid-modern">
                <div class="stat-card-modern">
                    <div class="stat-card-header">
                        <span class="stat-label">Total de Produtos</span>
                        <button class="stat-menu-btn"><i class="fas fa-ellipsis-v"></i></button>
                    </div>
                    <div class="stat-value" id="totalProdutos">0</div>
                    <div class="stat-trend-up">
                        <i class="fas fa-arrow-up"></i> Aumentou este mês
                    </div>
                </div>

                <div class="stat-card-modern">
                    <div class="stat-card-header">
                        <span class="stat-label">Serviços Finalizados</span>
                        <button class="stat-menu-btn"><i class="fas fa-ellipsis-v"></i></button>
                    </div>
                    <div class="stat-value" id="totalServicos">0</div>
                    <div class="stat-trend-up">
                        <i class="fas fa-arrow-up"></i> Aumentou este mês
                    </div>
                </div>

                <div class="stat-card-modern">
                    <div class="stat-card-header">
                        <span class="stat-label">Serviços em Andamento</span>
                        <button class="stat-menu-btn"><i class="fas fa-ellipsis-v"></i></button>
                    </div>
                    <div class="stat-value" id="totalVendas">0</div>
                    <div class="stat-trend-up">
                        <i class="fas fa-arrow-up"></i> Aumentou este mês
                    </div>
                </div>

                <div class="stat-card-modern">
                    <div class="stat-card-header">
                        <span class="stat-label">Total Faturado</span>
                        <button class="stat-menu-btn"><i class="fas fa-ellipsis-v"></i></button>
                    </div>
                    <div class="stat-value" id="receitaTotal">R$ 0,00</div>
                    <div class="stat-trend-discuss">
                        Em Discussão
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="charts-row-modern">
                <!-- Analytics Chart -->
                <div class="content-card-modern chart-card-enhanced">
                    <div class="card-header-modern">
                        <div>
                            <h3>Análise de Vendas</h3>
                            <p class="section-subtitle-modern">Visão geral do desempenho de vendas</p>
                        </div>
                        <div class="chart-controls-modern">
                            <button class="chart-toggle-modern active" data-period="monthly">Mensal</button>
                            <button class="chart-toggle-modern" data-period="yearly">Anual</button>
                        </div>
                    </div>
                    <div class="chart-stats-row">
                        <div class="chart-stat-item">
                            <span class="chart-stat-label">Total</span>
                            <span class="chart-stat-value" id="totalVendasChart">R$ 0,00</span>
                        </div>
                        <div class="chart-stat-item">
                            <span class="chart-stat-label">Média</span>
                            <span class="chart-stat-value" id="mediaVendasChart">R$ 0,00</span>
                        </div>
                        <div class="chart-stat-item">
                            <span class="chart-stat-label">Crescimento</span>
                            <span class="chart-stat-value positive" id="crescimentoVendasChart">+0%</span>
                        </div>
                    </div>
                    <div class="chart-wrapper-enhanced">
                        <canvas id="salesChart" width="800" height="300"></canvas>
                    </div>
                </div>

                <!-- Progress Donut Chart -->
                <div class="content-card-modern">
                    <div class="card-header-modern">
                        <h3>Progresso do Spa</h3>
                    </div>
                    <div class="donut-wrapper">
                        <canvas id="progressChart" width="400" height="400"></canvas>
                        <div class="chart-legend-modern">
                            <div class="legend-item-modern">
                                <span class="legend-dot-modern completed"></span>
                                <span>Concluído</span>
                            </div>
                            <div class="legend-item-modern">
                                <span class="legend-dot-modern in-progress"></span>
                                <span>Em Progresso</span>
                            </div>
                            <div class="legend-item-modern">
                                <span class="legend-dot-modern pending"></span>
                                <span>Pendente</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metas Section -->
            <div class="content-card-modern">
                <div class="card-header-modern">
                    <div>
                        <h3>Metas</h3>
                        <p class="section-subtitle-modern">Acompanhe o progresso das metas do spa</p>
                    </div>
                    <button class="btn-primary-large" onclick="openMetaModal()">
                        <i class="fas fa-plus"></i> Nova Meta
                    </button>
                </div>
                <div class="metas-grid" id="metasGrid">
                    <!-- Metas will be loaded here -->
                </div>
            </div>

            <!-- Two Column Layout -->
            <div class="dashboard-grid-modern">
                <!-- Recent Activity -->
                <div class="content-card-modern">
                    <div class="card-header-modern">
                        <h3>Atividades Recentes</h3>
                        <button class="btn-icon-modern" onclick="openAtividadesModal()">
                            <i class="fas fa-external-link-alt"></i> Ver mais
                        </button>
                    </div>
                    <div class="activity-list-modern" id="activityList">
                        <div class="empty-state-modern">
                            <i class="fas fa-inbox"></i>
                            <p>Nenhuma atividade recente</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="content-card-modern">
                    <div class="card-header-modern">
                        <h3>Ações Rápidas</h3>
                        <button class="btn-icon-modern">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                    <div class="quick-actions-grid-modern">
                        <a href="admin-produtos.html?action=new" class="quick-action-item">
                            <div class="quick-icon" style="background: linear-gradient(135deg, #10b981, #34d399);">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="quick-info">
                                <span class="quick-title">Novo Produto</span>
                                <span class="quick-date">Adicionar produto</span>
                            </div>
                        </a>
                        <a href="admin-servicos.html?action=new" class="quick-action-item">
                            <div class="quick-icon" style="background: linear-gradient(135deg, #6366f1, #818cf8);">
                                <i class="fas fa-spa"></i>
                            </div>
                            <div class="quick-info">
                                <span class="quick-title">Novo Serviço</span>
                                <span class="quick-date">Adicionar serviço</span>
                            </div>
                        </a>
                        <a href="admin-vendas.html?action=new" class="quick-action-item">
                            <div class="quick-icon" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="quick-info">
                                <span class="quick-title">Nova Venda</span>
                                <span class="quick-date">Registrar venda</span>
                            </div>
                        </a>
                        <a href="admin-agenda.html" class="quick-action-item">
                            <div class="quick-icon" style="background: linear-gradient(135deg, #8b5cf6, #a78bfa);">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="quick-info">
                                <span class="quick-title">Agenda</span>
                                <span class="quick-date">Ver agendamentos</span>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Meta Modal -->
    <div class="modal" id="metaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="metaModalTitle">Nova Meta</h2>
                <button class="modal-close" onclick="closeMetaModal()">&times;</button>
            </div>
            <form id="metaForm">
                <input type="hidden" id="metaId">
                
                <div class="form-group">
                    <label for="metaNome">Nome da Meta *</label>
                    <input type="text" id="metaNome" placeholder="Ex: Meta de Agendamentos" required>
                </div>

                <div class="form-group">
                    <label for="metaTabela">Tabela do Banco de Dados *</label>
                    <select id="metaTabela" required>
                        <option value="">Selecione uma tabela</option>
                        <option value="agendamentos">Agendamentos</option>
                        <option value="vendas">Vendas</option>
                        <option value="servicos">Serviços</option>
                        <option value="produtos">Produtos</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="metaColuna">Coluna para Medição *</label>
                    <select id="metaColuna" required>
                        <option value="">Selecione uma coluna</option>
                        <option value="count">Contagem Total</option>
                        <option value="valor">Valor Total</option>
                        <option value="compareceu">Atendimentos Realizados</option>
                        <option value="pago">Pagamentos Confirmados</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="metaValor">Valor da Meta *</label>
                        <input type="number" id="metaValor" step="0.01" min="0" placeholder="Ex: 100" required>
                    </div>
                    <div class="form-group">
                        <label for="metaPeriodo">Período *</label>
                        <select id="metaPeriodo" required>
                            <option value="mensal">Mensal</option>
                            <option value="semanal">Semanal</option>
                            <option value="diario">Diário</option>
                            <option value="anual">Anual</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="metaDescricao">Descrição</label>
                    <textarea id="metaDescricao" rows="3" placeholder="Descreva a meta..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeMetaModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar Meta</button>
                </div>
            </form>
        </div>
    </div>
        </div>
    </div>

    <!-- Modal de Ajuda (Help) -->
    <div class="modal" id="helpModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2><i class="fas fa-question-circle"></i> Central de Ajuda</h2>
                <button class="modal-close" onclick="closeHelpModal()">&times;</button>
            </div>
            <div class="help-content">
                <div class="help-section">
                    <h3><i class="fas fa-th-large"></i> Dashboard</h3>
                    <p>A tela principal com visão geral do sistema. Aqui você encontra:</p>
                    <ul>
                        <li><strong>Cards de Estatísticas:</strong> Total de produtos, serviços finalizados, serviços em andamento e projetos pendentes</li>
                        <li><strong>Análise de Vendas:</strong> Gráfico com visualização mensal/anual das vendas</li>
                        <li><strong>Progresso do Spa:</strong> Gráfico circular mostrando status dos projetos</li>
                        <li><strong>Metas:</strong> Acompanhamento de metas cadastradas</li>
                        <li><strong>Atividades Recentes:</strong> Últimas vendas e agendamentos</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3><i class="fas fa-box"></i> Produtos</h3>
                    <p>Gerenciamento completo do catálogo de produtos do spa.</p>
                    <ul>
                        <li>Cadastrar novos produtos com nome, descrição, preço e imagens</li>
                        <li>Editar informações de produtos existentes</li>
                        <li>Controlar estoque e disponibilidade</li>
                        <li>Visualizar histórico de vendas por produto</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3><i class="fas fa-spa"></i> Serviços</h3>
                    <p>Cadastro e gestão dos serviços oferecidos pelo spa.</p>
                    <ul>
                        <li>Criar novos serviços com duração e valor</li>
                        <li>Associar profissionais aos serviços</li>
                        <li>Definir disponibilidade e horários</li>
                        <li>Acompanhar serviços mais requisitados</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3><i class="fas fa-calendar-alt"></i> Agenda</h3>
                    <p>Sistema completo de agendamentos para o spa.</p>
                    <ul>
                        <li>Visualizar agenda por dia, semana ou mês</li>
                        <li>Criar novos agendamentos para clientes</li>
                        <li>Gerenciar horários dos profissionais</li>
                        <li>Receber notificações de agendamentos próximos</li>
                        <li>Confirmar comparecimento dos clientes</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3><i class="fas fa-shopping-cart"></i> Vendas</h3>
                    <p>Registro e controle de todas as vendas realizadas.</p>
                    <ul>
                        <li>Registrar novas vendas de produtos e serviços</li>
                        <li>Selecionar múltiplos itens em uma venda</li>
                        <li>Escolher forma de pagamento</li>
                        <li>Emitir comprovantes</li>
                        <li>Visualizar histórico de vendas com filtros</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3><i class="fas fa-chart-bar"></i> Analytics</h3>
                    <p>Relatórios e análises detalhadas do negócio.</p>
                    <ul>
                        <li>Gráficos de desempenho de vendas</li>
                        <li>Análise de produtos e serviços mais vendidos</li>
                        <li>Relatórios financeiros por período</li>
                        <li>Comparativos mensais e anuais</li>
                        <li>Exportação de dados para Excel/CSV</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3><i class="fas fa-images"></i> Galeria</h3>
                    <p>Gerenciamento de imagens do spa.</p>
                    <ul>
                        <li>Upload de fotos do spa e serviços</li>
                        <li>Organização por categorias</li>
                        <li>Edição e exclusão de imagens</li>
                        <li>Utilização em marketing e redes sociais</li>
                    </ul>
                </div>

                <div class="help-tips">
                    <h3><i class="fas fa-lightbulb"></i> Dicas Rápidas</h3>
                    <ul>
                        <li><strong>Dark Mode:</strong> Clique no ícone de lua/sol para alternar entre modo claro e escuro</li>
                        <li><strong>Atualizar:</strong> Use o botão de sincronização para atualizar os dados em tempo real</li>
                        <li><strong>Notificações:</strong> O sino mostra agendamentos e eventos importantes</li>
                        <li><strong>Suporte:</strong> Precisa de ajuda? Clique no ícone de envelope para abrir um chamado</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="closeHelpModal()">Entendi</button>
            </div>
        </div>
    </div>

    <!-- Modal de Suporte (Chamado) -->
    <div class="modal" id="supportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-headset"></i> Abrir Chamado de Suporte</h2>
                <button class="modal-close" onclick="closeSupportModal()">&times;</button>
            </div>
            <form id="supportForm">
                <div class="form-group">
                    <label for="supportAssunto">Assunto *</label>
                    <input type="text" id="supportAssunto" required placeholder="Ex: Erro ao salvar produto">
                </div>

                <div class="form-group">
                    <label for="supportCategoria">Categoria *</label>
                    <select id="supportCategoria" required>
                        <option value="">Selecione...</option>
                        <option value="bug">Bug / Erro</option>
                        <option value="duvida">Dúvida</option>
                        <option value="melhoria">Sugestão de Melhoria</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="supportDescricao">Descrição Detalhada *</label>
                    <textarea id="supportDescricao" rows="6" required placeholder="Descreva o problema ou dúvida em detalhes..."></textarea>
                </div>

                <div class="form-group">
                    <label for="supportImagem">Anexar Imagem (opcional)</label>
                    <input type="file" id="supportImagem" accept="image/*">
                    <small>Formatos aceitos: JPG, PNG, GIF (máx. 5MB)</small>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeSupportModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-paper-plane"></i> Enviar Chamado
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Notificações -->
    <div class="modal" id="notificationsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-bell"></i> Notificações</h2>
                <button class="modal-close" onclick="closeNotificationsModal()">&times;</button>
            </div>
            <div class="notifications-list" id="notificationsList">
                <!-- Notificações serão carregadas aqui -->
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="markAllAsRead()">Marcar Todas como Lidas</button>
                <button class="btn-primary" onclick="closeNotificationsModal()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Atividades Detalhadas -->
    <div class="modal" id="atividadesModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Todas as Atividades</h2>
                <button class="modal-close" onclick="closeAtividadesModal()">&times;</button>
            </div>

            <!-- Filtros -->
            <div class="filters-section">
                <div class="filters-row">
                    <div class="filter-group">
                        <label for="filterDataInicio">Data Início</label>
                        <input type="date" id="filterDataInicio" class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label for="filterDataFim">Data Fim</label>
                        <input type="date" id="filterDataFim" class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label for="filterTipo">Tipo</label>
                        <select id="filterTipo" class="filter-input">
                            <option value="">Todos</option>
                            <option value="venda">Vendas</option>
                            <option value="agendamento">Agendamentos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterProcedimento">Procedimento</label>
                        <input type="text" id="filterProcedimento" class="filter-input" placeholder="Buscar procedimento...">
                    </div>
                </div>
                <div class="filters-row">
                    <div class="filter-group">
                        <label for="filterPagamento">Forma de Pagamento</label>
                        <select id="filterPagamento" class="filter-input">
                            <option value="">Todas</option>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="cartao">Cartão</option>
                            <option value="pix">PIX</option>
                            <option value="transferencia">Transferência</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterVendedor">Vendedor</label>
                        <input type="text" id="filterVendedor" class="filter-input" placeholder="Buscar vendedor...">
                    </div>
                    <div class="filter-group">
                        <label for="filterStatus">Status</label>
                        <select id="filterStatus" class="filter-input">
                            <option value="">Todos</option>
                            <option value="completed">Concluído</option>
                            <option value="pending">Pendente</option>
                            <option value="cancelled">Cancelado</option>
                        </select>
                    </div>
                    <div class="filter-group filter-actions">
                        <button class="btn-primary" onclick="applyFilters()">
                            <i class="fas fa-filter"></i> Filtrar
                        </button>
                        <button class="btn-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista de Atividades -->
            <div class="activities-table-container">
                <table class="activities-table" id="atividadesTable">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Tipo</th>
                            <th>Descrição</th>
                            <th>Cliente</th>
                            <th>Valor</th>
                            <th>Pagamento</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="atividadesTableBody">
                        <tr>
                            <td colspan="8" class="empty-table">Nenhuma atividade encontrada</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeAtividadesModal()">Fechar</button>
                <button class="btn-primary" onclick="exportarAtividades()">
                    <i class="fas fa-download"></i> Exportar CSV
                </button>
            </div>
        </div>
    </div>

    <script src="admin.js"></script>
    <script src="chart.js"></script>
    <script>
        // Check authentication
        if (!sessionStorage.getItem('admin_authenticated')) {
            window.location.href = 'admin-login.html';
        }

        // Load user info
        const user = JSON.parse(sessionStorage.getItem('admin_user') || '{}');
        if (user.name) {
            document.getElementById('userName').textContent = user.name;
        }

        // Dark Mode Toggle
        function initDarkMode() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            const body = document.body;
            const icon = document.getElementById('darkModeIcon');
            const toggleBtn = document.getElementById('darkModeToggle');

            console.log('Initializing dark mode. Current mode:', darkMode);
            console.log('Toggle button found:', toggleBtn);
            console.log('Icon found:', icon);

            if (darkMode) {
                body.classList.add('dark-mode');
                if (icon) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                }
            }

            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    console.log('Dark mode button clicked!');
                    body.classList.toggle('dark-mode');
                    const isDark = body.classList.contains('dark-mode');
                    localStorage.setItem('darkMode', isDark);

                    console.log('Dark mode toggled. New state:', isDark);

                    if (icon) {
                        if (isDark) {
                            icon.classList.remove('fa-moon');
                            icon.classList.add('fa-sun');
                        } else {
                            icon.classList.remove('fa-sun');
                            icon.classList.add('fa-moon');
                        }
                    }

                    // Reinitialize charts with new colors
                    setTimeout(() => {
                        console.log('Reinitializing charts with dark mode:', isDark);
                        initCharts();
                    }, 100);
                });
            } else {
                console.error('Dark mode toggle button not found!');
            }
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('Deseja realmente sair?')) {
                sessionStorage.clear();
                window.location.href = 'admin-login.html';
            }
        });

        // Load dashboard stats
        function loadDashboardStats() {
            const produtos = JSON.parse(localStorage.getItem('ligon_produtos') || '[]');
            const servicos = JSON.parse(localStorage.getItem('ligon_servicos') || '[]');
            const vendas = JSON.parse(localStorage.getItem('ligon_vendas') || '[]');
            const agendamentos = JSON.parse(localStorage.getItem('ligon_agendamentos') || '[]');

            // Use static values if no data exists
            const totalProdutos = produtos.length || 24;
            const totalServicos = servicos.length || 10;
            const totalVendas = vendas.length || 12;
            const receitaTotal = vendas.length > 0 
                ? vendas.reduce((sum, v) => sum + (parseFloat(v.valorTotal) || 0), 0)
                : 125000;

            // Update DOM elements
            const totalProdutosEl = document.getElementById('totalProdutos');
            const totalServicosEl = document.getElementById('totalServicos');
            const totalVendasEl = document.getElementById('totalVendas');
            const receitaTotalEl = document.getElementById('receitaTotal');

            if (totalProdutosEl) totalProdutosEl.textContent = totalProdutos;
            if (totalServicosEl) totalServicosEl.textContent = totalServicos;
            if (totalVendasEl) totalVendasEl.textContent = totalVendas;
            if (receitaTotalEl) receitaTotalEl.textContent = formatCurrency(receitaTotal);

            // Load recent activity
            loadRecentActivity(vendas, agendamentos);
        }

        function loadRecentActivity(vendas, agendamentos) {
            const activityList = document.getElementById('activityList');
            if (!activityList) return;

            const recentVendas = vendas.length > 0 ? vendas.slice(-5).reverse() : [];
            const recentAgendamentos = agendamentos.length > 0 ? agendamentos.slice(-3).reverse() : [];

            // Use static data if no real data exists
            if (recentVendas.length === 0 && recentAgendamentos.length === 0) {
                const staticActivities = [
                    { type: 'venda', title: 'Nova venda realizada', meta: 'Hoje - R$ 2.450,00', status: 'completed' },
                    { type: 'agendamento', title: 'Agendamento: Maria Silva', meta: 'Hoje às 14:00', status: 'completed' },
                    { type: 'venda', title: 'Nova venda realizada', meta: 'Ontem - R$ 1.890,00', status: 'completed' },
                    { type: 'agendamento', title: 'Agendamento: Ana Costa', meta: 'Ontem às 16:30', status: 'pending' }
                ];

                let html = '';
                staticActivities.forEach(activity => {
                    const iconBg = activity.type === 'venda' 
                        ? 'linear-gradient(135deg, #10b981, #34d399)'
                        : 'linear-gradient(135deg, #6366f1, #818cf8)';
                    const icon = activity.type === 'venda' ? 'fa-shopping-cart' : 'fa-calendar-check';
                    
                    html += `
                        <div class="activity-item-modern">
                            <div class="activity-icon-modern" style="background: ${iconBg};">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">${activity.title}</div>
                                <div class="activity-meta">${activity.meta}</div>
                            </div>
                            <div class="activity-status ${activity.status}">${activity.status === 'completed' ? 'Concluído' : 'Pendente'}</div>
                        </div>
                    `;
                });
                activityList.innerHTML = html;
                return;
            }

            let html = '';
            
            recentVendas.forEach(venda => {
                html += `
                    <div class="activity-item-modern">
                        <div class="activity-icon-modern" style="background: linear-gradient(135deg, #10b981, #34d399);">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Nova venda realizada</div>
                            <div class="activity-meta">${venda.data || 'Hoje'} - ${formatCurrency(venda.valorTotal || 0)}</div>
                        </div>
                        <div class="activity-status completed">Concluído</div>
                    </div>
                `;
            });

            recentAgendamentos.forEach(ag => {
                html += `
                    <div class="activity-item-modern">
                        <div class="activity-icon-modern" style="background: linear-gradient(135deg, #6366f1, #818cf8);">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Agendamento: ${ag.clienteNome || 'Cliente'}</div>
                            <div class="activity-meta">${ag.data || 'Hoje'} às ${ag.hora || '10:00'}</div>
                        </div>
                        <div class="activity-status ${ag.compareceu ? 'completed' : 'pending'}">${ag.compareceu ? 'Concluído' : 'Pendente'}</div>
                    </div>
                `;
            });

            activityList.innerHTML = html;
        }

        // Chart period state
        let currentPeriod = 'monthly';
        let salesChartInstance = null;

        // Initialize charts
        function initCharts() {
            console.log('Initializing charts...');

            // Sales Chart (Bar Chart) - Enhanced with stats
            const salesData = generateSalesData(currentPeriod);
            const isDark = document.body.classList.contains('dark-mode');
            // Cores mais vibrantes e destacadas da paleta Ligon
            const chartColors = ['#059669', '#10b981', '#34d399', '#10b981', '#059669', '#047857', '#065f46'];

            console.log('Sales data:', salesData);

            // Update chart stats
            const totalVendas = salesData.values.reduce((a, b) => a + b, 0);
            const mediaVendas = totalVendas / salesData.values.length;
            const crescimentoVendas = salesData.values.length > 1
                ? ((salesData.values[salesData.values.length - 1] - salesData.values[0]) / salesData.values[0] * 100).toFixed(1)
                : 96.0; // Static growth value

            const totalVendasEl = document.getElementById('totalVendasChart');
            const mediaVendasEl = document.getElementById('mediaVendasChart');
            const crescimentoEl = document.getElementById('crescimentoVendasChart');

            console.log('Updating stats elements...');
            if (totalVendasEl) {
                totalVendasEl.textContent = formatCurrency(totalVendas);
                console.log('Total vendas updated:', totalVendas);
            }
            if (mediaVendasEl) {
                mediaVendasEl.textContent = formatCurrency(mediaVendas);
                console.log('Media vendas updated:', mediaVendas);
            }
            if (crescimentoEl) {
                crescimentoEl.textContent = (crescimentoVendas >= 0 ? '+' : '') + crescimentoVendas + '%';
                crescimentoEl.className = 'chart-stat-value ' + (crescimentoVendas >= 0 ? 'positive' : 'negative');
                console.log('Crescimento updated:', crescimentoVendas);
            }

            // Initialize chart - ensure canvas is visible and has dimensions
            try {
                const canvasElement = document.getElementById('salesChart');
                if (!canvasElement) {
                    console.error('Canvas element not found');
                    return;
                }

                console.log('Canvas found, initializing...');

                // Clear existing canvas
                const ctx = canvasElement.getContext('2d');
                if (ctx) {
                    ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                }

                // Ensure canvas container is visible
                const container = canvasElement.parentElement;
                if (container) {
                    container.style.display = 'block';
                    container.style.visibility = 'visible';
                    container.style.opacity = '1';
                }

                // Set explicit dimensions
                canvasElement.style.width = '100%';
                canvasElement.style.height = '320px';
                canvasElement.style.display = 'block';

                console.log('Creating chart with data:', salesData.values);

                // Create new chart instance
                salesChartInstance = new SimpleChart('salesChart', {
                    type: 'bar',
                    data: salesData.values,
                    labels: salesData.labels,
                    colors: chartColors,
                    highlightedIndex: currentPeriod === 'monthly' ? 6 : 5, // Highlight last bar
                    darkMode: isDark
                });

                console.log('Chart created successfully');
            } catch (error) {
                console.error('Error initializing chart:', error);
            }
            
            // Progress Chart (Donut Chart)
            const produtosData = JSON.parse(localStorage.getItem('ligon_produtos') || '[]');
            const servicosData = JSON.parse(localStorage.getItem('ligon_servicos') || '[]');
            const vendasData = JSON.parse(localStorage.getItem('ligon_vendas') || '[]');
            const agendamentosData = JSON.parse(localStorage.getItem('ligon_agendamentos') || '[]');

            const totalProgress = produtosData.length + servicosData.length + vendasData.length + agendamentosData.length;
            const completed = vendasData.length + agendamentosData.filter(a => a.compareceu).length;
            const inProgress = servicosData.length + agendamentosData.filter(a => !a.compareceu && a.status !== 'cancelado').length;
            const pending = produtosData.length + agendamentosData.filter(a => a.status === 'cancelado').length;

            // Use static data if no real data exists
            const progressData = totalProgress > 0
                ? [completed, inProgress, pending]
                : [65, 25, 10]; // Static values for demonstration

            new SimpleChart('progressChart', {
                type: 'donut',
                data: progressData,
                labels: ['Concluído', 'Em Progresso', 'Pendente'],
                colors: ['#059669', '#6366f1', '#f59e0b'], // Verde mais vibrante para destaque
                centerText: 'Concluído',
                darkMode: isDark
            });
        }
        
        // Generate sample sales data with static values
        function generateSalesData(period = 'monthly') {
            if (period === 'monthly') {
                // Dados estáticos mensais (últimos 7 meses)
                const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul'];
                const staticValues = [12500, 18200, 15200, 21000, 19500, 22800, 24500];

                return {
                    labels: months,
                    values: staticValues
                };
            } else if (period === 'yearly') {
                // Dados estáticos anuais (últimos 6 anos)
                const years = ['2019', '2020', '2021', '2022', '2023', '2024'];
                const staticValues = [145000, 168000, 192000, 215000, 248000, 285000];

                return {
                    labels: years,
                    values: staticValues
                };
            }

            // Default: monthly
            return {
                labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul'],
                values: [12500, 18200, 15200, 21000, 19500, 22800, 24500]
            };
        }

        // Chart period toggle - Fixed to work properly
        function setupChartToggle() {
            document.querySelectorAll('.chart-toggle-modern').forEach(btn => {
                btn.addEventListener('click', function() {
                    const period = this.getAttribute('data-period');

                    // Update current period
                    if (period === 'monthly') {
                        currentPeriod = 'monthly';
                    } else if (period === 'yearly') {
                        currentPeriod = 'yearly';
                    }

                    // Update button states
                    document.querySelectorAll('.chart-toggle-modern').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // Reinitialize chart with new period
                    initCharts();
                });
            });
        }

        // Metas Management
        function loadMetas() {
            const metas = JSON.parse(localStorage.getItem('ligon_metas') || '[]');
            const metasGrid = document.getElementById('metasGrid');
            
            if (metas.length === 0) {
                metasGrid.innerHTML = `
                    <div class="empty-state-modern">
                        <div class="empty-icon-wrapper">
                            <i class="fas fa-bullseye"></i>
                        </div>
                        <h3 class="empty-title">Nenhuma meta cadastrada</h3>
                        <p class="empty-description">Comece criando sua primeira meta para acompanhar o progresso do spa</p>
                        <button class="btn-create-first-meta" onclick="openMetaModal()">
                            <i class="fas fa-plus-circle"></i>
                            <span>Criar Primeira Meta</span>
                        </button>
                    </div>
                `;
                return;
            }

            metasGrid.innerHTML = metas.map(meta => {
                const progresso = calcularProgressoMeta(meta);
                const porcentagem = Math.min(100, (progresso.atual / progresso.meta) * 100);
                
                return `
                    <div class="meta-card">
                        <div class="meta-card-header">
                            <div class="meta-icon" style="background: linear-gradient(135deg, ${getMetaColor(meta.tabela)});">
                                <i class="fas ${getMetaIcon(meta.tabela)}"></i>
                            </div>
                            <div class="meta-info">
                                <h4>${meta.nome}</h4>
                                <p class="meta-subtitle">${meta.descricao || meta.tabela} - ${meta.periodo}</p>
                            </div>
                            <div class="meta-actions">
                                <button class="btn-icon-small" onclick="editMeta('${meta.id}')" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon-small" onclick="deleteMeta('${meta.id}')" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="meta-progress">
                            <div class="meta-values">
                                <span class="meta-atual">${formatMetaValue(progresso.atual, meta.coluna)}</span>
                                <span class="meta-total">/ ${formatMetaValue(progresso.meta, meta.coluna)}</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${porcentagem}%; background: linear-gradient(135deg, ${getMetaColor(meta.tabela)});"></div>
                            </div>
                            <div class="meta-percentage">
                                <span class="${porcentagem >= 100 ? 'success' : porcentagem >= 75 ? 'warning' : 'danger'}">
                                    ${porcentagem.toFixed(1)}%
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function calcularProgressoMeta(meta) {
            let atual = 0;
            const hoje = new Date();
            let inicioPeriodo = new Date();
            
            switch(meta.periodo) {
                case 'diario':
                    inicioPeriodo.setHours(0, 0, 0, 0);
                    break;
                case 'semanal':
                    inicioPeriodo.setDate(hoje.getDate() - hoje.getDay());
                    inicioPeriodo.setHours(0, 0, 0, 0);
                    break;
                case 'mensal':
                    inicioPeriodo.setDate(1);
                    inicioPeriodo.setHours(0, 0, 0, 0);
                    break;
                case 'anual':
                    inicioPeriodo.setMonth(0, 1);
                    inicioPeriodo.setHours(0, 0, 0, 0);
                    break;
            }

            const dados = JSON.parse(localStorage.getItem(`ligon_${meta.tabela}`) || '[]');
            
            switch(meta.coluna) {
                case 'count':
                    atual = dados.filter(item => {
                        const dataItem = new Date(item.dataCadastro || item.data || new Date());
                        return dataItem >= inicioPeriodo;
                    }).length;
                    break;
                case 'valor':
                    atual = dados.filter(item => {
                        const dataItem = new Date(item.dataCadastro || item.data || new Date());
                        return dataItem >= inicioPeriodo;
                    }).reduce((sum, item) => sum + (parseFloat(item.valorTotal || item.preco || 0)), 0);
                    break;
                case 'compareceu':
                    atual = dados.filter(item => {
                        const dataItem = new Date(item.data || new Date());
                        return dataItem >= inicioPeriodo && item.compareceu === true;
                    }).length;
                    break;
                case 'pago':
                    atual = dados.filter(item => {
                        const dataItem = new Date(item.data || new Date());
                        return dataItem >= inicioPeriodo && item.pago === true;
                    }).length;
                    break;
            }

            return {
                atual: atual,
                meta: parseFloat(meta.valor)
            };
        }

        function formatMetaValue(value, tipo) {
            if (tipo === 'valor') {
                return formatCurrency(value);
            }
            return Math.round(value).toString();
        }

        function getMetaColor(tabela) {
            const colors = {
                'agendamentos': '#6366f1, #818cf8',
                'vendas': '#10b981, #34d399',
                'servicos': '#8b5cf6, #a78bfa',
                'produtos': '#f59e0b, #fbbf24'
            };
            return colors[tabela] || '#10b981, #34d399';
        }

        function getMetaIcon(tabela) {
            const icons = {
                'agendamentos': 'fa-calendar-check',
                'vendas': 'fa-shopping-cart',
                'servicos': 'fa-spa',
                'produtos': 'fa-box'
            };
            return icons[tabela] || 'fa-bullseye';
        }

        function openMetaModal(metaId = null) {
            const modal = document.getElementById('metaModal');
            const form = document.getElementById('metaForm');
            const modalTitle = document.getElementById('metaModalTitle');
            
            form.reset();
            document.getElementById('metaId').value = '';
            
            if (metaId) {
                const metas = JSON.parse(localStorage.getItem('ligon_metas') || '[]');
                const meta = metas.find(m => m.id === metaId);
                if (meta) {
                    modalTitle.textContent = 'Editar Meta';
                    document.getElementById('metaId').value = meta.id;
                    document.getElementById('metaNome').value = meta.nome;
                    document.getElementById('metaTabela').value = meta.tabela;
                    document.getElementById('metaColuna').value = meta.coluna;
                    document.getElementById('metaValor').value = meta.valor;
                    document.getElementById('metaPeriodo').value = meta.periodo;
                    document.getElementById('metaDescricao').value = meta.descricao || '';
                }
            } else {
                modalTitle.textContent = 'Nova Meta';
            }

            modal.classList.add('show');
        }

        function closeMetaModal() {
            document.getElementById('metaModal').classList.remove('show');
        }

        function editMeta(metaId) {
            openMetaModal(metaId);
        }

        function deleteMeta(metaId) {
            if (confirm('Deseja realmente excluir esta meta?')) {
                const metas = JSON.parse(localStorage.getItem('ligon_metas') || '[]');
                const filtered = metas.filter(m => m.id !== metaId);
                localStorage.setItem('ligon_metas', JSON.stringify(filtered));
                showNotification('Meta excluída com sucesso!');
                loadMetas();
            }
        }

        // Handle meta form submission
        document.getElementById('metaForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const metas = JSON.parse(localStorage.getItem('ligon_metas') || '[]');
            const metaId = document.getElementById('metaId').value;
            
            const meta = {
                id: metaId || generateId(),
                nome: document.getElementById('metaNome').value,
                tabela: document.getElementById('metaTabela').value,
                coluna: document.getElementById('metaColuna').value,
                valor: parseFloat(document.getElementById('metaValor').value),
                periodo: document.getElementById('metaPeriodo').value,
                descricao: document.getElementById('metaDescricao').value,
                dataCriacao: metaId ? metas.find(m => m.id === metaId)?.dataCriacao || new Date().toISOString() : new Date().toISOString(),
                dataAtualizacao: new Date().toISOString()
            };

            if (metaId) {
                const index = metas.findIndex(m => m.id === metaId);
                metas[index] = meta;
                showNotification('Meta atualizada com sucesso!');
            } else {
                metas.push(meta);
                showNotification('Meta criada com sucesso!');
            }

            localStorage.setItem('ligon_metas', JSON.stringify(metas));
            closeMetaModal();
            loadMetas();
        });

        // Initialize metas storage
        if (!localStorage.getItem('ligon_metas')) {
            localStorage.setItem('ligon_metas', '[]');
        }

        // Initialize everything
        function initializeDashboard() {
            initDarkMode();  // Initialize dark mode first
            loadDashboardStats();
            loadMetas();
            setupChartToggle();
            initCharts();
        }

        // Run initialization - wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDashboard);
        } else {
            // DOM is already ready
            initializeDashboard();
        }

        // Also try on window load as fallback
        window.addEventListener('load', () => {
            setTimeout(() => {
                loadDashboardStats();
                initCharts();
            }, 100);
        });

        // ==================== Modal de Atividades ====================

        let allActivities = [];
        let filteredActivities = [];

        function openAtividadesModal() {
            loadAllActivities();
            document.getElementById('atividadesModal').classList.add('show');
        }

        function closeAtividadesModal() {
            document.getElementById('atividadesModal').classList.remove('show');
        }

        function loadAllActivities() {
            const vendas = JSON.parse(localStorage.getItem('ligon_vendas') || '[]');
            const agendamentos = JSON.parse(localStorage.getItem('ligon_agendamentos') || '[]');

            allActivities = [];

            // Adicionar vendas
            vendas.forEach(venda => {
                allActivities.push({
                    tipo: 'venda',
                    data: venda.data || new Date().toISOString(),
                    hora: venda.hora || '00:00',
                    descricao: venda.itens ? venda.itens.map(i => i.nome).join(', ') : 'Venda',
                    cliente: venda.clienteNome || 'Cliente',
                    valor: parseFloat(venda.valorTotal) || 0,
                    pagamento: venda.formaPagamento || 'N/A',
                    status: venda.pago ? 'completed' : 'pending',
                    vendedor: venda.vendedor || 'N/A',
                    id: venda.id
                });
            });

            // Adicionar agendamentos
            agendamentos.forEach(ag => {
                allActivities.push({
                    tipo: 'agendamento',
                    data: ag.data || new Date().toISOString(),
                    hora: ag.hora || '00:00',
                    descricao: ag.servicoNome || 'Agendamento',
                    cliente: ag.clienteNome || 'Cliente',
                    valor: parseFloat(ag.valor) || 0,
                    pagamento: ag.formaPagamento || 'N/A',
                    status: ag.compareceu ? 'completed' : (ag.status === 'cancelado' ? 'cancelled' : 'pending'),
                    vendedor: ag.profissional || 'N/A',
                    id: ag.id
                });
            });

            // Ordenar por data decrescente
            allActivities.sort((a, b) => {
                const dateA = new Date(a.data + ' ' + a.hora);
                const dateB = new Date(b.data + ' ' + b.hora);
                return dateB - dateA;
            });

            // Adicionar dados estáticos se não houver dados reais
            if (allActivities.length === 0) {
                allActivities = [
                    {
                        tipo: 'venda',
                        data: new Date().toISOString().split('T')[0],
                        hora: '14:30',
                        descricao: 'Massagem Relaxante + Aromaterapia',
                        cliente: 'Maria Silva',
                        valor: 2450.00,
                        pagamento: 'Cartão',
                        status: 'completed',
                        vendedor: 'Ana Costa',
                        id: 'static-1'
                    },
                    {
                        tipo: 'agendamento',
                        data: new Date().toISOString().split('T')[0],
                        hora: '16:00',
                        descricao: 'Spa Day Completo',
                        cliente: 'João Santos',
                        valor: 3500.00,
                        pagamento: 'PIX',
                        status: 'pending',
                        vendedor: 'Carlos Mendes',
                        id: 'static-2'
                    },
                    {
                        tipo: 'venda',
                        data: new Date(Date.now() - 86400000).toISOString().split('T')[0],
                        hora: '10:15',
                        descricao: 'Tratamento Facial Premium',
                        cliente: 'Ana Costa',
                        valor: 1890.00,
                        pagamento: 'Dinheiro',
                        status: 'completed',
                        vendedor: 'Maria Souza',
                        id: 'static-3'
                    }
                ];
            }

            filteredActivities = [...allActivities];
            renderActivitiesTable();
        }

        function applyFilters() {
            const dataInicio = document.getElementById('filterDataInicio').value;
            const dataFim = document.getElementById('filterDataFim').value;
            const tipo = document.getElementById('filterTipo').value;
            const procedimento = document.getElementById('filterProcedimento').value.toLowerCase();
            const pagamento = document.getElementById('filterPagamento').value;
            const vendedor = document.getElementById('filterVendedor').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;

            filteredActivities = allActivities.filter(activity => {
                let match = true;

                if (dataInicio && activity.data < dataInicio) match = false;
                if (dataFim && activity.data > dataFim) match = false;
                if (tipo && activity.tipo !== tipo) match = false;
                if (procedimento && !activity.descricao.toLowerCase().includes(procedimento)) match = false;
                if (pagamento && activity.pagamento.toLowerCase() !== pagamento) match = false;
                if (vendedor && !activity.vendedor.toLowerCase().includes(vendedor)) match = false;
                if (status && activity.status !== status) match = false;

                return match;
            });

            renderActivitiesTable();
        }

        function clearFilters() {
            document.getElementById('filterDataInicio').value = '';
            document.getElementById('filterDataFim').value = '';
            document.getElementById('filterTipo').value = '';
            document.getElementById('filterProcedimento').value = '';
            document.getElementById('filterPagamento').value = '';
            document.getElementById('filterVendedor').value = '';
            document.getElementById('filterStatus').value = '';

            filteredActivities = [...allActivities];
            renderActivitiesTable();
        }

        function renderActivitiesTable() {
            const tbody = document.getElementById('atividadesTableBody');

            if (filteredActivities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-table">Nenhuma atividade encontrada</td></tr>';
                return;
            }

            const html = filteredActivities.map(activity => {
                const statusClass = activity.status === 'completed' ? 'status-completed' :
                                  activity.status === 'cancelled' ? 'status-cancelled' : 'status-pending';
                const statusText = activity.status === 'completed' ? 'Concluído' :
                                 activity.status === 'cancelled' ? 'Cancelado' : 'Pendente';
                const tipoIcon = activity.tipo === 'venda' ? 'fa-shopping-cart' : 'fa-calendar-check';
                const tipoText = activity.tipo === 'venda' ? 'Venda' : 'Agendamento';

                return `
                    <tr>
                        <td>
                            <div class="table-date">${formatDate(activity.data)}</div>
                            <div class="table-time">${activity.hora}</div>
                        </td>
                        <td>
                            <span class="tipo-badge tipo-${activity.tipo}">
                                <i class="fas ${tipoIcon}"></i> ${tipoText}
                            </span>
                        </td>
                        <td>${activity.descricao}</td>
                        <td>${activity.cliente}</td>
                        <td class="table-value">${formatCurrency(activity.valor)}</td>
                        <td>${activity.pagamento}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn-icon-small" onclick="viewActivityDetails('${activity.id}')" title="Ver detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = html;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('pt-BR');
        }

        function viewActivityDetails(id) {
            const activity = allActivities.find(a => a.id === id);
            if (activity) {
                alert('Detalhes da atividade:\n\n' + JSON.stringify(activity, null, 2));
                // Aqui você pode implementar um modal de detalhes mais elaborado
            }
        }

        function exportarAtividades() {
            if (filteredActivities.length === 0) {
                alert('Nenhuma atividade para exportar');
                return;
            }

            const csv = [
                ['Data', 'Hora', 'Tipo', 'Descrição', 'Cliente', 'Valor', 'Pagamento', 'Status', 'Vendedor'],
                ...filteredActivities.map(a => [
                    formatDate(a.data),
                    a.hora,
                    a.tipo === 'venda' ? 'Venda' : 'Agendamento',
                    a.descricao,
                    a.cliente,
                    a.valor.toFixed(2),
                    a.pagamento,
                    a.status === 'completed' ? 'Concluído' : a.status === 'cancelled' ? 'Cancelado' : 'Pendente',
                    a.vendedor
                ])
            ].map(row => row.join(';')).join('\n');

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `atividades_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // ==================== Modal de Ajuda ====================

        function openHelpModal() {
            document.getElementById('helpModal').classList.add('show');
        }

        function closeHelpModal() {
            document.getElementById('helpModal').classList.remove('show');
        }

        // ==================== Modal de Suporte ====================

        function openSupportModal() {
            document.getElementById('supportModal').classList.add('show');
        }

        function closeSupportModal() {
            document.getElementById('supportModal').classList.remove('show');
            document.getElementById('supportForm').reset();
        }

        // Handle support form submission
        document.getElementById('supportForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const user = JSON.parse(sessionStorage.getItem('admin_user') || '{}');
            const imageFile = document.getElementById('supportImagem').files[0];

            const chamado = {
                id: generateId(),
                usuario: user.email || 'admin@ligon.com',
                nomeUsuario: user.name || 'Administrador',
                assunto: document.getElementById('supportAssunto').value,
                categoria: document.getElementById('supportCategoria').value,
                descricao: document.getElementById('supportDescricao').value,
                dataAbertura: new Date().toISOString(),
                status: 'aberto',
                imagem: null
            };

            // Se houver imagem, converter para base64
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    chamado.imagem = e.target.result;
                    saveChamado(chamado);
                };
                reader.readAsDataURL(imageFile);
            } else {
                saveChamado(chamado);
            }
        });

        function saveChamado(chamado) {
            const chamados = JSON.parse(localStorage.getItem('ligon_chamados') || '[]');
            chamados.push(chamado);
            localStorage.setItem('ligon_chamados', JSON.stringify(chamados));

            showNotification('Chamado enviado com sucesso! Em breve entraremos em contato.');
            closeSupportModal();

            console.log('Chamado registrado:', chamado);
        }

        // ==================== Modal de Notificações ====================

        function openNotificationsModal() {
            loadNotifications();
            document.getElementById('notificationsModal').classList.add('show');
        }

        function closeNotificationsModal() {
            document.getElementById('notificationsModal').classList.remove('show');
        }

        function loadNotifications() {
            const agendamentos = JSON.parse(localStorage.getItem('ligon_agendamentos') || '[]');
            const hoje = new Date().toISOString().split('T')[0];
            const amanha = new Date(Date.now() + 86400000).toISOString().split('T')[0];

            // Filtrar agendamentos de hoje e amanhã
            const notificacoes = [];

            agendamentos.forEach(ag => {
                if (ag.data === hoje && !ag.compareceu) {
                    notificacoes.push({
                        tipo: 'agendamento-hoje',
                        titulo: 'Agendamento Hoje',
                        mensagem: `${ag.clienteNome} - ${ag.servicoNome} às ${ag.hora}`,
                        data: ag.data,
                        hora: ag.hora,
                        lida: false,
                        id: ag.id
                    });
                } else if (ag.data === amanha && !ag.compareceu) {
                    notificacoes.push({
                        tipo: 'agendamento-amanha',
                        titulo: 'Agendamento Amanhã',
                        mensagem: `${ag.clienteNome} - ${ag.servicoNome} às ${ag.hora}`,
                        data: ag.data,
                        hora: ag.hora,
                        lida: false,
                        id: ag.id
                    });
                }
            });

            // Adicionar notificações estáticas se não houver dados
            if (notificacoes.length === 0) {
                notificacoes.push(
                    {
                        tipo: 'agendamento-hoje',
                        titulo: 'Agendamento Hoje',
                        mensagem: 'Maria Silva - Massagem Relaxante às 14:00',
                        data: hoje,
                        hora: '14:00',
                        lida: false,
                        id: 'notif-1'
                    },
                    {
                        tipo: 'agendamento-hoje',
                        titulo: 'Agendamento Hoje',
                        mensagem: 'João Santos - Spa Day às 16:00',
                        data: hoje,
                        hora: '16:00',
                        lida: false,
                        id: 'notif-2'
                    },
                    {
                        tipo: 'agendamento-amanha',
                        titulo: 'Agendamento Amanhã',
                        mensagem: 'Ana Costa - Tratamento Facial às 10:00',
                        data: amanha,
                        hora: '10:00',
                        lida: false,
                        id: 'notif-3'
                    }
                );
            }

            // Atualizar contador
            document.getElementById('notificationCount').textContent = notificacoes.length;

            // Renderizar notificações
            const lista = document.getElementById('notificationsList');
            if (notificacoes.length === 0) {
                lista.innerHTML = '<div class="empty-notifications"><i class="fas fa-bell-slash"></i><p>Nenhuma notificação no momento</p></div>';
                return;
            }

            const html = notificacoes.map(notif => {
                const iconClass = notif.tipo.includes('hoje') ? 'fa-calendar-day' : 'fa-calendar-alt';
                const colorClass = notif.tipo.includes('hoje') ? 'notif-urgent' : 'notif-warning';

                return `
                    <div class="notification-item ${colorClass}">
                        <div class="notif-icon">
                            <i class="fas ${iconClass}"></i>
                        </div>
                        <div class="notif-content">
                            <h4>${notif.titulo}</h4>
                            <p>${notif.mensagem}</p>
                            <span class="notif-time">${notif.data} às ${notif.hora}</span>
                        </div>
                    </div>
                `;
            }).join('');

            lista.innerHTML = html;
        }

        function markAllAsRead() {
            document.getElementById('notificationCount').textContent = '0';
            showNotification('Todas as notificações foram marcadas como lidas');
        }

        // ==================== Função de Refresh ====================

        function refreshDashboard() {
            const refreshBtn = document.getElementById('refreshBtn');
            const icon = refreshBtn.querySelector('i');

            // Adicionar animação de rotação
            icon.classList.add('fa-spin');
            refreshBtn.disabled = true;

            // Recarregar dados
            setTimeout(() => {
                loadDashboardStats();
                loadMetas();
                initCharts();
                loadNotifications();

                icon.classList.remove('fa-spin');
                refreshBtn.disabled = false;

                showNotification('Dados atualizados com sucesso!');
            }, 1000);
        }
    </script>
</body>
</html>
